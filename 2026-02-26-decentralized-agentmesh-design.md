# AgentMesh 去中心化代理互联层设计与落地路线（产品/战略向）

日期：2026-02-26  
受众：产品/战略团队  
定位：面向具备 LLM 能力的代理之间的“去中心化互联层”，提供身份可验证的自治注册、语义发现、跨协议调用、信任与资源治理。非编排框架，不以人类用户为主要入口。

## 1. 现状摘要
- 功能基线：中心化注册/发现/调用网关，支持 HTTP、自定义、a2a、MCP、gRPC、WebSocket；内存/Redis/Postgres 存储；Python SDK、CLI、Web 控制台；API Key/JWT、限流、Prometheus 指标；心跳与基本统计。
- 缺口：多租户与强身份缺失；注册/发现中心化；缺语义检索；调用缺签名握手与预算；信任评分浅；跨网段不可达；缺审计与压测。

## 2. 目标
- 自治注册/发现：代理可在局域或联邦网络中自注册并传播清单，无中心单点。
- 语义发现：自然语言/能力描述即可找到合适代理，融合向量检索与信任排序。
- 可验证调用：调用前握手与双向签名，支持可选 mTLS，确保来源与用途可验证。
- 资源与信任治理：声明与执行 QPS/并发预算，记录调用收据，基于成功率/事件的信任评分。
- 渐进去中心化：短期联邦/种子节点 + 直连数据面，中期 gossip 增量同步，远期可选 DHT。

## 3. 架构概览
- 控制平面：轻量 Registry/Relay 节点（可复用当前 AgentMesh 服务形态），承担目录存储、联邦同步、信任计算、向量索引管理。
- 数据平面：代理间直连调用为主，跨网段时经可选中继仅转信令或全通道。
- 身份与信任：Agent ID = 公钥派生；Manifest 强签名；信任分层（高/低信任），事件衰减模型。
- 发现路径：查询 → 本地向量检索 → 规则/信任混排 → 本地/上游增量补全 → 返回候选。
- 调用握手：调用方签名 token（用途、过期、预算、caller 公钥），被调方验证后执行；可返回签名收据。

## 4. 关键设计
### 4.1 Manifest 扩展（注册模型）
- 新增字段：`public_key`（必填）、`agent_id`（公钥派生）、`manifest_signature`、`capabilities`（文本/标签）、`models`、`context_window`, `pricing`, `qps_budget`, `concurrency_limit`, `vector_desc`（摘要用于嵌入）。
- 兼容策略：短期允许无签名注册但标记低信任；配置开关 `require_signed_registration`.

### 4.2 联邦/种子同步
- 端点：`/federation/pull?since=<ts>` 返回增量（含签名与信任分），后续可加 `/push`.
- 同步任务：定时拉取种子列表（配置 `SEEDS`, `SYNC_INTERVAL`），按 `updated_at`/`id` 合并；信任低于阈值的条目可丢弃或标记。
- 冲突解决：`updated_at` 优先；签名不匹配则拒绝。
- 过渡拓扑：每子网 1-2 个 seed/relay；支持跨子网中继但数据面保持直连优先。

### 4.3 语义发现与混排
- 向量索引：Faiss/Annoy 本地索引，嵌入来源 `vector_desc`; 旁路进程或嵌入服务均可。
- API：`discover` 支持自然语言查询，返回 `score = α·vector + β·trust + γ·health`；可过滤协议/标签/预算。
- CLI：`agentmesh discover --query "..." --top-k 10`.

### 4.4 握手与安全令牌
- Token 内容：caller 公钥、用途、过期、预算、幂等键、trace_id，可选调用签名摘要。
- 传输：HTTP 头或元数据；gRPC/WS 采用 metadata；响应可携带签名收据。
- 校验：过期、签名、公钥匹配、预算上限、信任阈值；可配置 mTLS。

### 4.5 本地限流与预算执行
- 机制：令牌桶/并发信号量，按 caller 或全局；扣账策略与拒绝码统一。
- Manifest 声明的 `qps_budget`/`concurrency_limit` 在被调方本地执行。
- 审计：每次拒绝或扣账写结构化日志；可导出指标。

### 4.6 信任与评分 v2
- 因子：近期成功率（衰减）、超时/错误、心跳缺失、签名不一致、滥用举报；事件权重可配置。
- 输出：`trust_score` 0-1，分层：高信任/一般/低信任；发现与同步均使用。
- 端点：`/trust/{agent_id}` 查询；同步响应带评分。

### 4.7 中继与路由（可选）
- 中继类型：信令中继（目录+握手元数据）或全通道中继（低信任分区或不可达场景）。
- 路由策略：同子网优先，次选低延迟高信任，最后回退中继。

### 4.8 观测与审计
- 日志：调用/握手的结构化日志（trace_id, caller_id, budget, result）。
- 指标：同步成功率、延迟分布、拒绝原因、信任分布；Prometheus 暴露。
- OTel：透传 trace context；可选事件导出。

## 5. 落地路线（迭代节奏）
- 0-45 天：Manifest 扩展 + 注册签名校验（PR1）；联邦增量同步 + 配置（PR2）；握手 token + 可选 mTLS（PR4）；限流/预算执行（PR5）。
- 45-90 天：向量检索接入发现（PR3）；信任评分 v2（PR6）；基础观测/审计（PR8）。
- 90-180 天：中继/路由策略（PR7）；多语言 SDK/CLI 对齐与示例（PR9）；发布压测与容量指南。
- 180-365 天：可选 DHT/CRDT 目录、激励与计费、跨组织信任域、托管 relay/seed 服务。

## 6. PR 级拆分（供工程排期）
- PR1 身份与注册模型：新增字段、公钥派生 ID、签名强校验、存储索引、兼容开关、注册签名测试。
- PR2 联邦增量同步：`/federation/pull` 端点、定时拉取任务、冲突与信任过滤、同步重试测试。
- PR3 语义发现：向量索引集成、混排公式、`discover` 扩展、CLI 支持、召回/排序测试。
- PR4 握手安全：签名 token 结构、请求/响应签名验证、mTLS 可选、过期/伪造/回退测试。
- PR5 限流与预算：令牌桶/并发控制、Manifest 声明执行、拒绝码与审计、压测脚本。
- PR6 信任评分 v2：事件模型、衰减算法、评分查询端点、发现/同步带分、评分测试。
- PR7 中继/路由（可选）：信令/全通道中继、路由策略、不可达回退测试。
- PR8 观测与审计：结构化日志、OTel 透传、指标暴露、日志/指标存在性测试。
- PR9 SDK/CLI 对齐：签名注册与发现/调用、种子配置、示例脚本、集成测试链路。

## 7. 安全与风险
- 风险：未签名节点冒充、跨网段 DoS、弱信任条目污染目录、预算绕过、日志缺失导致审计盲区。
- 缓解：默认强制签名与过期校验；信任阈值过滤同步；本地限流+幂等键；黑/灰名单下发；结构化审计日志。

## 8. 采纳与体验
- 快速启动：`agentmesh serve --federation.seeds=... --require-signed-registration`；内置种子列表与示例 agent 自注册脚本。
- Web 控制台转为运维/观测视角：展示拓扑、信任分布、调用审计、向量搜索结果。
- SDK 路线：Python 先行，TS/Go 生成 OpenAPI + 签名工具；CLI 覆盖注册/发现/调用/同步。

## 9. 验证与度量
- 功能验收：注册签名校验、增量同步成功率>99%、语义查询前 10 召回率、限流与预算拒绝准确率。
- 性能基准：单节点 QPS、P95/P99 延迟；同步延迟；向量检索延迟；中继开销。
- 可靠性：种子失效回退、同步冲突处理、不可达回退中继。

## 10. 结论
- 通过“强身份 + 联邦同步 + 语义发现 + 可验证调用 + 本地预算 + 信任评分”组合，AgentMesh 能从中心化目录演进为去中心化代理互联层，同时保持渐进可落地。
- 建议按 0-45 天窗口先完成身份/同步/握手/限流四件套，确保基础安全与可运行；随后接入语义发现与信任 v2 打开体验与治理；再推进路由、中继、生态与压测以支撑规模化。
