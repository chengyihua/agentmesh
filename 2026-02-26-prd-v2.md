# AgentMesh 去中心化代理互联层 PRD v2 (Implementation Baseline)

**日期**：2026-02-26
**状态**：Phase 1-7 已实现 (Beta)
**基准文档**：`2026-02-26-decentralized-agentmesh-design.md`

## 1. 概述
AgentMesh 是一个去中心化的代理（Agent）互联层，旨在解决多 Agent 系统中的身份验证、服务发现、安全调用和信任管理问题。
经过前期的开发迭代，目前已完成核心的去中心化基础设施建设，包括基于公钥的强身份体系、联邦增量同步、向量语义发现、安全握手协议、分布式限流、动态信任评分系统以及**中继网络 (Relay Network)**。

本 PRD 文档基于当前代码库的实际实现状态，对比原设计文档，明确当前功能基线与后续迭代方向。

## 2. 核心功能现状 (Phase 1-7)

### 2.1 强身份与注册 (Identity & Registration) - [已完成]
- **实现机制**：
  - **Agent ID**：基于 Ed25519 公钥的确定性派生，防止 ID 欺诈。
  - **Manifest 签名**：注册时必须附带 `manifest_signature`，Registry 强制校验签名有效性。
  - **字段扩展**：支持 `qps_budget`, `concurrency_limit`, `vector_desc`, `protocols` 等元数据。
- **差异点**：
  - 原设计中的 `capabilities` 文本字段目前主要通过 `skills` 列表和 `description` 实现，辅以 `vector_desc` 用于语义检索。
  - CLI `register` 命令已集成私钥签名逻辑。

### 2.2 联邦与同步 (Federation & Sync) - [已完成]
- **实现机制**：
  - **增量同步**：支持基于 `updated_at` 的增量拉取 (`pull_updates`)。
  - **种子节点**：支持配置 `seeds`，节点启动后自动从种子节点引导数据。
  - **P2P 同步**：支持节点间对等同步，不依赖单一种子。
  - **信任过滤**：同步过程中包含信任分数，但本地信任分数通过 `TrustManager` 独立计算与维护，避免恶意节点污染信任值。
- **差异点**：
  - 实现了基于 AsyncIO 的后台同步任务，每 60s (默认) 执行一次。

### 2.3 语义发现 (Semantic Discovery) - [已完成]
- **实现机制**：
  - **向量索引**：集成 `VectorIndexManager` (基于 FAISS 或内存余弦相似度)，对 Agent 的 `vector_desc` 或 `description` 进行嵌入。
  - **混合检索**：`discover_agents` 接口支持自然语言查询 (`q`)、标签 (`tags`)、协议 (`protocol`) 和最小信任分 (`min_trust`) 过滤。
  - **CLI 支持**：`agentmesh discover` 命令已支持所有过滤参数。

### 2.4 安全握手 (Handshake & Security) - [已完成]
- **实现机制**：
  - **协议头**：调用时强制携带 `X-Agent-ID`, `X-Agent-Timestamp`, `X-Agent-Signature`。
  - **重放保护**：服务端校验时间戳窗口 (默认 60s)。
  - **完整性校验**：对请求 Body 进行哈希签名，防止篡改。
- **差异点**：
  - 暂未强制 mTLS，目前主要依赖应用层签名握手。mTLS 作为可选配置项在路线图中。

### 2.5 限流与预算 (Rate Limiting) - [已完成]
- **实现机制**：
  - **本地执行**：在被调方 (Registry/Server) 根据 Agent Card 声明的 `qps_budget` 和 `concurrency_limit` 进行本地限流。
  - **令牌桶算法**：使用 `AgentRateLimiter` 实现平滑限流。
  - **反馈机制**：触发限流时返回标准化的 429 错误，并触发信任评分下降 (`TrustEvent.RATE_LIMIT`)。

### 2.6 信任管理 v2 (Trust Management) - [已完成]
- **实现机制**：
  - **事件驱动**：基于交互结果 (Success, Failure, Timeout, BadSig, RateLimit) 实时更新内存中的信任分。
  - **时间衰减**：后台任务定期 (`_decay_loop`) 将信任分向中性值 (0.5) 衰减，确保长期不活跃节点的信任度回归基准。
  - **持久化**：定期 (`_flush_loop`) 将信任分更新回刷到存储层。
  - **透明度**：提供详细的信任分构成 (`breakdown`) 查询接口，包含各项事件的统计计数与衰减记录。

### 2.7 中继网络 (Relay Network) - [已完成]
- **实现机制**：
  - **WebSocket 隧道**：内网 Agent 通过 WebSocket 连接到 Relay Server (`/relay/v1/ws/{agent_id}`)，建立反向隧道。
  - **安全握手**：连接建立时进行挑战-响应 (Challenge-Response) 身份验证，确保 Agent 拥有对应的私钥。
  - **请求转发**：Relay Server 接收到对 `relay://{agent_id}` 的 HTTP 调用请求后，封装为 JSON 消息通过 WebSocket 转发给目标 Agent。
  - **CLI 集成**：`agentmesh connect` 命令支持一键连接 Relay Server 并转发请求到本地端口。
  - **端到端调用**：支持 `Registry.invoke_agent` 自动识别 `relay` 协议并路由请求。

## 3. 架构组件对比

| 组件 | 设计目标 | 当前实现 | 状态 |
| :--- | :--- | :--- | :--- |
| **Registry** | 存储、索引、同步 | 内存/Redis/PG 适配，集成向量索引 | ✅ |
| **TrustManager** | 评分、衰减、持久化 | 事件驱动评分 + 自动衰减循环 | ✅ |
| **FederationManager** | 跨节点数据同步 | 种子/P2P 增量同步 | ✅ |
| **SecurityManager** | 签名、验签、密钥管理 | Ed25519/RSA 支持，握手协议 | ✅ |
| **Gateway/Protocol** | 多协议适配 | HTTP, MCP, WebSocket, Relay | ✅ |
| **RelayManager** | 内网穿透与路由 | WebSocket 反向隧道 + 签名握手 | ✅ |
| **Telemetry** | 观测性 | Prometheus Metrics, Logging | ✅ |

## 4. 缺口分析 (Gap Analysis)

1.  **大规模压测 (Scale Testing)**
    - **现状**：单元测试和集成测试覆盖了功能逻辑。
    - **缺口**：缺乏 100+ 节点规模下的联邦同步延迟、收敛速度和 gossip 协议开销的实测数据。
    - **计划**：Phase 8 重点。

2.  **多语言支持 (Polyglot Support)**
    - **现状**：仅提供 Python SDK 和 CLI。
    - **缺口**：Node.js/Go/Rust 等语言的 Agent 接入尚需封装 SDK 或手动实现协议。

## 5. 后续路线图 (Roadmap)

### Phase 8: 稳定性与规模 (Stability & Scale) [待启动]
- 引入 DHT (Kademlia) 替代全量联邦同步，支持海量节点发现。
- 完善混沌工程测试 (Chaos Engineering)。
- 进行 100+ 节点的大规模组网压测。

### Phase 9: 开发者体验 (DX) [待启动]
- 提供 Web UI 可视化网络拓扑与信任关系。
- 推出 TypeScript SDK。

## 6. 结论
当前 AgentMesh 已成功构建了去中心化互联所需的基石（身份、发现、信任、安全）。代码库与 `2026-02-26-decentralized-agentmesh-design.md` 设计文档高度一致，并在信任模型的细节实现上（如衰减算法、Breakdown 视图）进行了深化。

建议立即着手 Phase 7 (中继网络) 的设计与验证，以解决真实网络环境下的连通性问题。
